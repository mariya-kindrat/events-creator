version: 1
frontend:
    phases:
        preBuild:
            commands:
                - echo "=== Development Environment Pre-Build Phase ==="
                - echo "Node.js version:" $(node --version)
                - echo "NPM version:" $(npm --version)
                - echo "Current directory:" $(pwd)
                - echo "Branch: $AWS_BRANCH"
                - echo "Environment: DEVELOPMENT"
                - echo "Environment check..."
                - env | grep -E "(NODE_ENV|DATABASE_URL|NEXTAUTH|GOOGLE|STRIPE|NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY)" || echo "No matching env vars found"
                - node scripts/validate-env-amplify.js
                - echo "Installing dependencies..."
                - npm ci --no-audit --no-fund || npm install --no-audit --no-fund --include=dev
                - npm dedupe || true
                - echo "Dependencies installed successfully"
                - echo "Verifying PostCSS dependencies..."
                - npm list autoprefixer postcss tailwindcss || echo "Some PostCSS dependencies missing"
                - echo "Generating Prisma client..."
                - npx prisma generate
                - echo "Prisma client generated successfully"
                - echo "Running development-specific setup..."
                - npm run setup-db || echo "Database setup skipped"
        build:
            commands:
                - echo "=== Development Environment Build Phase ==="
                - echo "Original NODE_ENV:" $NODE_ENV
                - echo "AWS_BRANCH:" $AWS_BRANCH
                - echo "Setting NODE_ENV=development for build process"
                - export NODE_ENV=development
                - echo "Building Next.js application for development..."
                - npm run build:test
                - echo "Development build completed successfully"
        postBuild:
            commands:
                - echo "=== Development Environment Post Build Phase ==="
                - echo "Listing build output..."
                - ls -la .next/ || echo "No .next directory found"
                - echo "Checking standalone output..."
                - ls -la .next/standalone/ || echo "No standalone directory found"
                - echo "Running post-build tests..."
                - npm run lint || echo "Linting skipped"
                - echo "Development build artifacts ready"
    artifacts:
        baseDirectory: .next
        files:
            - "**/*"
    cache:
        paths:
            - node_modules/**/*
            - .next/cache/**/*
            - .cache/**/*
    customHeaders:
        - pattern: '**/*'
          headers:
            - key: 'X-Environment'
              value: 'development'
            - key: 'X-Frame-Options'
              value: 'DENY'
            - key: 'X-Content-Type-Options'
              value: 'nosniff'