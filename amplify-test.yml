version: 1
frontend:
    phases:
        preBuild:
            commands:
                - echo "=== Test Environment Pre-Build Phase ==="
                - echo "Node.js version:" $(node --version)
                - echo "NPM version:" $(npm --version)
                - echo "Current directory:" $(pwd)
                - echo "Environment check for TEST environment..."
                - env | grep -E "(NODE_ENV|DATABASE_URL|NEXTAUTH|GOOGLE|STRIPE|NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY)" || echo "No matching env vars found"
                - node scripts/validate-env-amplify.js
                - echo "Installing dependencies..."
                - npm ci --no-audit --no-fund || npm install --no-audit --no-fund --include=dev
                - npm dedupe || true
                - echo "Dependencies installed successfully"
                - echo "Verifying PostCSS dependencies..."
                - npm list autoprefixer postcss tailwindcss || echo "Some PostCSS dependencies missing"
                - echo "Setting up test database..."
                - node scripts/setup-test-db.js || echo "Test database setup failed, continuing..."
                - echo "Generating Prisma client..."
                - npx prisma generate
                - echo "Prisma client generated successfully"
        build:
            commands:
                - echo "=== Test Environment Build Phase ==="
                - echo "Setting NODE_ENV to development for test environment..."
                - export NODE_ENV=development
                - echo "Building Next.js application for testing..."
                - npm run build:amplify
                - echo "Build completed successfully"
        postBuild:
            commands:
                - echo "=== Test Environment Post Build Phase ==="
                - echo "Listing build output..."
                - ls -la .next/ || echo "No .next directory found"
                - echo "Checking standalone output..."
                - ls -la .next/standalone/ || echo "No standalone directory found"
                - echo "Test environment build artifacts ready"
    artifacts:
        baseDirectory: .next
        files:
            - "**/*"
    cache:
        paths:
            - node_modules/**/*
            - .next/cache/**/*
