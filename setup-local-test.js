#!/usr/bin/env node

/**
 * Interactive setup script for local test environment
 */

const fs = require("fs");
const path = require("path");
const readline = require("readline");

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
});

function askQuestion(question) {
    return new Promise((resolve) => {
        rl.question(question, (answer) => {
            resolve(answer);
        });
    });
}

async function setupLocalTest() {
    console.log("üöÄ Setting up local test environment...\n");

    // Check if .env.local already exists
    const envLocalPath = path.join(__dirname, ".env.local");
    if (fs.existsSync(envLocalPath)) {
        const overwrite = await askQuestion(
            "‚ö†Ô∏è  .env.local already exists. Overwrite? (y/N): "
        );
        if (overwrite.toLowerCase() !== "y") {
            console.log("‚ùå Setup cancelled.");
            rl.close();
            return;
        }
    }

    console.log("üìã Please provide the following information:\n");

    // Get test database URL
    const testDbUrl = await askQuestion(
        "üóÑÔ∏è  Enter your test database URL from Neon: "
    );
    if (!testDbUrl.trim()) {
        console.log("‚ùå Test database URL is required!");
        rl.close();
        return;
    }

    // Get test URL (optional for local)
    const testUrl = await askQuestion(
        "üåê Enter your test environment URL (or press Enter for localhost): "
    );
    const nextAuthUrl = testUrl.trim() || "http://localhost:3000";

    // Get NextAuth secret
    const nextAuthSecret = await askQuestion(
        "üîê Enter NextAuth secret for test (or press Enter for default): "
    );
    const authSecret =
        nextAuthSecret.trim() || "test-secret-change-this-in-production";

    // Create .env.local content
    const envContent = `# Local Test Environment Configuration
# Generated by setup-local-test.js

# Test Database
DATABASE_URL="${testDbUrl}"

# NextAuth Configuration
NEXTAUTH_URL="${nextAuthUrl}"
NEXTAUTH_SECRET="${authSecret}"
NODE_ENV="development"

# OAuth Credentials
GOOGLE_ID="${process.env.GOOGLE_ID || ""}"
GOOGLE_SECRET="${process.env.GOOGLE_SECRET || ""}"

# Stripe Test Keys
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="${
        process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY || ""
    }"
STRIPE_SECRET_KEY="${process.env.STRIPE_SECRET_KEY || ""}"
`;

    // Write .env.local file
    try {
        fs.writeFileSync(envLocalPath, envContent);
        console.log("\n‚úÖ .env.local file created successfully!");

        // Ask if user wants to set up the test database now
        const setupDb = await askQuestion(
            "\nüóÑÔ∏è  Set up test database now? (Y/n): "
        );
        if (setupDb.toLowerCase() !== "n") {
            console.log("\nüîÑ Setting up test database...");

            // Set environment variable for the setup script
            process.env.DATABASE_TEST_URL = testDbUrl;

            // Run the database setup
            const { execSync } = require("child_process");
            try {
                execSync("npm run setup-test-db", { stdio: "inherit" });
                console.log("\nüéâ Test environment setup completed!");
                console.log("\nüìù Next steps:");
                console.log("   1. Run: npm run dev");
                console.log("   2. Visit: http://localhost:3000");
                console.log(
                    "   3. Test your application with the test database"
                );
            } catch (error) {
                console.log(
                    "\n‚ö†Ô∏è  Database setup failed. You can run it manually later with:"
                );
                console.log("   npm run setup-test-db");
            }
        } else {
            console.log("\nüìù Manual setup required:");
            console.log("   1. Run: npm run setup-test-db");
            console.log("   2. Run: npm run dev");
        }
    } catch (error) {
        console.error("‚ùå Error creating .env.local:", error.message);
    }

    rl.close();
}

setupLocalTest().catch(console.error);
